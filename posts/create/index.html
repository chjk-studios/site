<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Post (Auth Required)</title>
  <link rel="stylesheet" href="/posts/styles.css">
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.0/firebase-auth-compat.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-logo">
      <img src="/images/logo.png" class="logo-nav">
      <span class="logo-text"><a href="#" style="cursor: url('/cursors/pixel-black/hand.cur'), auto;">Chickenjockey</a></span>
    </div>
    <div class="nav-menu">
      <a href="/" class="nav-link">Home</a>
      <a href="#projects" class="nav-link">Projects</a>
      <a href="#links" class="nav-link">Links</a>
      <a href="#contact" class="nav-link">Contact</a>
      <a href="/posts" class="nav-link">Posts</a>
    </div>
  </nav>
  <div class="main-part">
    <h1>Create New Post</h1>

    <!-- Login form -->
    <div id="authSection">
      <h3>Login</h3>
      <input type="email" id="email" placeholder="Email" required /><br/>
      <input type="password" id="password" placeholder="Password" required /><br/>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" style="display: none;">Logout</button>
    </div>

    <!-- Create post form -->
    <div id="postSection" style="display: none;">
      <form id="createPostForm">
        <label for="title">Post Title:</label><br/>
        <input type="text" id="title" required><br/><br/>

        <label for="content">Post Content:</label><br/>
        <textarea id="content" rows="6" cols="50" required></textarea><br/><br/>

        <button type="submit">Create Post</button>
        <button onclick="auth.signOut();">Logout</button>
      </form>
    </div>

    <div id="status"></div>
  </div>

  <script>
    // TODO: Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDXz5Kdf72C1Ks-xSauqd5Q1cKZTuBoy-U",
      authDomain: "chickenjockey-studio.firebaseapp.com",
      projectId: "chickenjockey-studio",
      storageBucket: "chickenjockey-studio.firebasestorage.app",
      messagingSenderId: "1012362162434",
      appId: "1:1012362162434:web:6f9ce36d04abcc33fa521b"
    };

    const firebaseErrorMessages = {
      'auth/invalid-credential': 'Invalid credentials. (This login is for Site admins)',
      'auth/user-not-found': 'No user found with this email. (This login is for Site admins)',
      'auth/email-already-in-use': 'This email is already registered.',
      'auth/weak-password': 'Your password is too weak.',
      'auth/invalid-email': 'Please enter a valid email address.',
      'auth/wrong-password': 'Incorrect password. Please try again.',
      'auth/too-many-requests': 'Too many login attempts. Please try again later.',
      'auth/missing-password': 'Please enter a password.',
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const authSection = document.getElementById("authSection");
    const postSection = document.getElementById("postSection");
    const statusDiv = document.getElementById("status");

    // Show/hide UI based on auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        authSection.style.display = "none";
        postSection.style.display = "block";
        document.getElementById("logoutBtn").style.display = "inline";
      } else {
        authSection.style.display = "block";
        postSection.style.display = "none";
        document.getElementById("logoutBtn").style.display = "none";
      }
    });

    // Login logic
    document.getElementById("loginBtn").addEventListener("click", () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          statusDiv.textContent = "Logged in!";
        })
        .catch(error => {
          console.error(error);
          //statusDiv.textContent = "Login error: " + error.message;
          const friendlyMessage = firebaseErrorMessages[error.code] || 'An unexpected error occurred. Please try again.';
          showErrorToUser(friendlyMessage);
        });
    });

    function showErrorToUser(message) {
      const errorDiv = document.getElementById('status');
      errorDiv.textContent = message;
    }

    // Logout logic
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut();
      statusDiv.textContent = "Logged out!";
    });

    // Create post logic
    const form = document.getElementById("createPostForm");
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user) {
        statusDiv.textContent = "You must be logged in to create a post.";
        return;
      }

      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();

      if (!title || !content) {
        statusDiv.textContent = "Please fill out all fields.";
        return;
      }

      db.collection("posts").add({
        title,
        content,
        authorId: user.uid, // track the post owner
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        statusDiv.textContent = "Post created successfully!";
        form.reset();
      }).catch(error => {
        console.error("Error adding post: ", error);
        statusDiv.textContent = "Error creating post.";
      });
    });
  </script>
</body>
</html>
